[블록체인 관조적으로 파헤치기](http://enhanced.kr/postviewer/374) 시리즈의 글입니다.

작업증명은 블록체인 시스템 내에서 장부를 위조하는 뻥쟁이들을 걸러내기 위한 합의 알고리즘이다. 이 알고리즘의 핵심은 **쓸데없는 노가다**에 있다.



## 원리

블록체인 네트워크에서 장부는 모든 노드에게 다 퍼져있다. 만약, 이 장부를 수정하는데 비용이 들지 않는다면 뻥쟁이는 혼자서 모든 노드의 장부를 순식간에 조작하고 모른 체 해버릴 수 있을 것이다. 하지만 장부를 수정하는데 시간이 든다면 그 모든 장부를 조작하기 위해 소수의 뻥쟁이는 엄청난 노가다를 감당해야 한다.

이 노가다가 흔히 말하는 'mining'이다. 블록체인에 새로운 블록을 추가하기 위해 어려운 연산을 수행해야 하며 이 때문에 블록을 추가하는데에 연산시간이 생긴다. 그럼 규칙을 따르는 사용자가 다수라는 전제 하에 지멋대로 행동하는 소수의 뻥쟁이들에 비해 블록을 생성하는 속도가 빨라지고, 따라서 길이가 짧은 블록은 뻥이라고 봐도 무방하다는 게 PoW의 핵심이다.

### Mining (블록 추가)

앞에서 언급한 노가다(채굴)는 역산이 불가능한 Hash의 결과가 일정값 미만이 되도록 **nonce** 라는 값을 찍어서 때려맞추는 작업이다. 

1. 블록의 해시값 끝에 nonce를 붙이고, 이 문자열을 해시한다.
2. 해시의 결과가 **특정 값(target)** 미만이면 작업증명이 통과된다.
3. 작업증명을 최초로 통과한 노드가 자신의 블록을 생성한다.

### 검증

마이닝을 하다보면 한 블록에 대해 상반된 내용을 담고 있는 다른 블록이 생성될 수 있다. 다음 그림을 보자.

<img src="https://raw.githubusercontent.com/42deSix/Images/master/PoW_description.png" width="95%"/>

블록을 하나 생성하는데 약 10분이 걸린다고 가정하자. '묠니르는 신의 무기다'라는 내용을 담고 있는 Block A에서 토르가 10분 정도를 소요해서 묠니르가 자신의 소유라는 블록 B를 생성했다고 하자. 라그나로크의 국민들은 이를 인정하여 B에다가 '토르의 묠니르는 번개를 부른다', '묠니르는 오직 토르만 들 수 있다', '토르가 손을 뻗으면 묠니르가 토르의 손으로 날아간다'와 같은 C, D, E 등의 블록을 덧붙여 만든다. 여러 국민들이 동시에 블록을 생성하기 시작했기 때문에 10분만에 수십개의 블록이 C 뒤로 달리게 된다. 

한편, 토르가 B 블록을 생성하자마자 로키는 묠니르의 소유를 자신으로 옮기려고 10분에 걸쳐서 '묠니르는 로키의 소유'라는 X 블록을 만들었다. 하지만 그 동안 이미 B 블록을 필두로 한 가지의 길이는 충분히 길어져 있다. 로키의 지지자는 토르의 지지자에 비해 적기 때문에 이 결과를 절대 뒤집을 수 없다. 

따라서 PoW 알고리즘을 사용하는 블록체인에서는 

1. 블록체인에 참여하는 사람이 충분히 많다.
2. 악의적인 사용자의 수가 전체 사용자 수의 절반 미만이다.

위 두가지 조건만 충족한다면 무조건 길이가 긴 가지를 유효한 가지로 인정하면 문제가 없게 되는 것이다.

### 난이도

앞서 "블록을 하나 생성하는데 약 10분이 걸린다고 가정"했었다. 그 말은 마이닝을 하여 새로운 블록이 생성될 때까지 10분이 걸린다는 뜻이다. 이 시간은 절대적으로 정해진 게 아니고, 각 시스템마다 블록이 생성되는데 걸린 시간에 대한 통계치를 기반으로 **난이도**를 조절하여 적당히 유지시킨다. 앞에서 "해시의 결과가 **특정 값(target)** 미만이면 작업증명이 통과된다"고 했었는데, 이 '특정 값'이 작을 수록 해시의 결과가 그 값 미만일 확률이 내려가고 결과적으로 난이도가 올라가게 된다.

비트코인의 경우 이 시간을 10분 정도로 유지시키고 있으며, 이더리움의 경우는 12초 정도로 유지시키고 있다고 한다(새로운 블록의 생성을 네트워크에 완전히 전파하는데 걸리는 시간이 12초 정도라서 그 밑으로 떨어뜨리지 않는 것이라고 한다).



## 보상

블록체인 시스템이 어떤 목적으로 만들어졌느냐에 따라 다를 수 있겠지만, 보통 별다른 보상이 없으면 어떤 노드도 노가다를 감수해가며 새로운 블록을 만들려고 하지 않을 것이다. 그래서 블록체인 시스템에는 새로운 블록을 생성하는 것에 대한 보상이 주어진다. 비트코인의 경우를 예로 들면 그 보상은 다음의 2가지이다.

1. 채굴자에게 일정량의 비트코인을 지급하는 것을 새로운 블록의 최초 거래로 한다.
2. 해당 블록에 딸려 오는 모든 거래에 대한 수수료를 채굴자에게 지급한다. 이 수수료는 거래마다 거래 당사자끼리 자율적으로 결정할 수 있으며 거래의 우선순위에도 영향을 미친다.



## 문제점

PoW 방식은 불필요한 노가다가 필요하다. 이 점이 다음과 같은 문제점들을 만든다.

### 거래속도 저하

블록체인 네트워크는 기본적으로 각 노드의 장부를 동기화해야 하기 때문에 트랜잭션의 처리 속도가 느리다. 근데 PoW 방식이 도입됐을 때 장부 동기화 문제는 문제로 보이지도 않을만큼 트랜잭션 처리 속도가 심각하게 느려진다. 실제로 비트코인의 경우 송금하는데 몇시간에서 길게는 며칠씩 걸리기도 한다.

| <img src="https://raw.githubusercontent.com/42deSix/Images/master/bitcoin_transfer_time.png" width="95%"/> |
| :----------------------------------------------------------: |
|                            ㄷㄷㄷ                            |

### 환경문제

채굴은 컴퓨팅파워를 활용한 연산으로 이루어지고 컴퓨터는 전기를 잡아먹는다. 그럼 전기는 어디서 오는가. 친환경 에너지가 많은 양의 전기를 생산한다고는 하나, 아직까지 상당량의 전기는 화력발전소에 의존한다. 결국 환경을 오염시켜서 장부의 유효성을 검증하는 셈이다. 



## 대안?

**지분증명(PoS, Proof of Stake)** 방식이 위의 문제들을 어느 정도 해결해줄 수 있다. 다음 글에서는 PoS에 대해 다루겠다.