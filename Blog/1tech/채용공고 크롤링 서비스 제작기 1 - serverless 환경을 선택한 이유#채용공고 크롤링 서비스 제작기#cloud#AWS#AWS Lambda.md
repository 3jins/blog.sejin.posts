괴물 같은 개발실력을 가진 내 친구 한 명은 이런 말을 한 적이 있다.

> 저는 같은 일을 3번 이상 반복해야 되면 코드로 짜버려요.

사실 이건 그 친구니까 가능한 거고, 내 개발실력으로는 거의 모든 경우에 대해서 코딩해서 자동화하는 것보다 내 손으로 직접 같은 일을 반복하는 게 압도적으로 저렴하다. 하지만 저 말을 들은 이후로는, 같은 일이 3번 이상 반복된다 싶으면 이걸 코드로 만드는 게 나을지에 대한 고민 정도는 하게 됐다.

쓸데없이 눈만 높았던, 그래서 이제서야 눈을 낮추기 시작한 나는 취준생활을 몇달 째 하고 있는 중이다. 그에 따라 가고 싶은 회사의 채용공고를 확인하는 일이 잦은데, 이게 [정말 처음에 눈이 높을 때로 높았던 시절](https://enhanced.kr/postviewer/116)에는 확인할 회사가 몇 군데 없어서 괜찮았지만, 눈을 좀만 낮추니까 상당히 귀찮은 작업이 되어버렸다. 이 반복적인 일을 자동화하기 위해 난 [채용공고 크롤링 서비스 잡식(Job Seek)](https://github.com/3jins/job-seek)을 만들었다.

알고 있는 기술들 조합해서 뚝딱뚝딱 했으니 만드는 것까진 어렵지 않았다. 문제는 인프라 구성을 어떻게 할 것인가 하는 부분에 있었다. 잡식의 경우는 주기적으로 한 번에 많은 크롤링을 수행해야 하는 배치서버가 필요하기 때문에 서비스 이용자가 있든 없든 서버에 어느 정도 신경을 써야 하기 때문이다.

이번 시리즈는 크롤링 서버를 왜 AWS Lambda에서 구동하기로 했는지, 어떻게 AWS Lambda에 Node.js 프로젝트를 배포하여 사용했는지, 그리고 그 과정에서 어떤 삽질을 했는지를 기록한 글이다.



## Prerequisite Knowledge

서론에서 이미 다 스포해버렸듯이 AWS Lambda를 쓰기로 결정을 내렸다. 이 결정을 이해하기 위해서는 다음의 지식을 갖춰야 한다. 이미 뭔지 알고 계신 갓발자 분들, 클라우드가 주무기인 주니어 분들, 그리고 이미 구글링을 통해 지식을 습득하고 오신 분들은 넘어가도 좋다.

### FaaS (Function as a Service)

EC2와 같은 IaaS 서비스는 서버 구동환경을 제공해준다. 따라서 IaaS 위에는 24시간 내내 돌아가는 서버 어플리케이션을 구동할 수 있다.

반면, FaaS는 함수 구동환경을 제공한다. 트리거를 통해 FaaS에 올려둔 함수를 동작시킬 수 있고, FaaS에서 동작하는 함수의 작동이 끝나면 FaaS도 꺼진다.

FaaS는 다음과 같은 장단점을 지닌다.

- pros
    - 함수가 동작하는 동안만 비용이 발생하므로 비용을 절약할 수 있다.
    - 사용자에게 제공해준 서버가 없기 때문에 인프라에 대해 신경쓸 필요가 없다. 확장성에 대한 고민을 할 필요 없이 그냥 많이 쓰면 많이 쓰는거고, 인프라의 보안, 구성 등에 대한 고민도 필요가 없다.
- cons
    - 함수가 한 번 실행될 때 쓸 수 있는 시간과 메모리량에 제한이 있다. 과거에는 5분, 1500MB였는데 [지금은 15분, 3008MB](https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/limits.html)로 늘어난 듯하다. 따라서 기계학습 등의 용도로 쓰기에는 부적합하다. 그 외에도 동시에 1000개를 넘는 함수를 실행할 수 없는 등 몇가지 제약사항이 더 존재한다.
    - 사용자에게 제공해준 서버가 없다는 것은 장점일 수도 단점일 수도 있다. 환경변수, 세션 등 서버에 의존하는 상태정보를 쓰기 어렵다.

### AWS Lambda

AWS에서 제공하는 FaaS다. 일반적으로 프로그래밍에서 [람다표현식이라 하면 익명함수를 나타내는데](https://en.wikipedia.org/wiki/Anonymous_function), 여기서 이름이 유래한 것으로 보인다.

### Serverless

기본적으로 serverless는 FaaS나 BaaS처럼 서버가 없는 클라우드 환경을 일컫는다. 여기서 설명할 [serverless](https://serverless.com/)는 이와 같은 serverless 환경에 코드를 배포하기 쉽도록 도와주는 라이브러리다. yml 설정파일과 cli 환경을 통해 여러 FaaS에 코드를 손쉽게 배포할 수 있도록 도와준다.



## 왜 AWS Lambda인가

### On-premise vs Serverless Cloud

이 글을 쓰고 있는 시점에서, 이 블로그는 그냥 싼 가격에 제공하는 AWS EC2의 하위호환격 호스팅 대행업체를 이용해서 포스팅하고 있다. 댓글 등의 일부 기능이 미완성이라 대대적인 홍보 작업을 하지도 않았고, 글도 컨셉 없이 그냥 공부한 거 아무거나 싸지르고 있어서 그런지 유입자가 거의 없기 때문에 그런 결정을 내렸다~~(심지어 리팩토링할 때 뭐 잘못 건드려서 SEO도 꼬인 것 같다)~~. 따라서 어떻게든 떠있기만 하면 되고, 1GB 램을 제공하는 서버 호스팅 업체의 상품을 이용하고 있다. ~~블로그 로딩속도가 느린 건 코드가 개판인 것보다는 사실 이 때문이다.~~

하지만 잡식은 블로그와는 상황이 좀 다르다. 웹서버만 돌아가는 게 아니라 크롤링 배치서버가 따로 돌아가야 하기 때문이다. 잡식 크롤링서버가 갖춰야 하는 요구조건은 다음과 같다.

- 백수는 돈이 없다. 비용이 싸야 한다.
- 자취방에 인터넷을 안 깔고 핸드폰 핫스팟을 사용하고 있다. 취직하면 회사 앞으로 이사할 생각이라 인터넷을 새로 깔 생각도 없다. 즉, 홈서버를 돌릴 수 없다.
- 하루에 채용공고가 그렇게 자주 바뀌는 건 아니기 때문에 트래픽의 총량은 적지만, 채용공고 본문을 html 채로 긁어오므로 매 크롤링을 할 때 집중되는 트래픽 양은 적지 않다.
- crontab처럼 주기적인 실행이 가능해야 한다.
- 크롤링할 회사가 늘어난다면 이를 감당할 수 있게 성능 확장을 해야 한다.

Cloud FaaS는 위의 조건을 모두 충족한다. AWS Lambda 기준으로 다음과 같은 특징을 갖는다.

- 쓴 만큼만 돈을 낸다. 게다가 [매월 100만건의 요청과 40만GB*sec 만큼의 컴퓨팅 양은 무료](https://aws.amazon.com/ko/lambda/pricing/)로 제공된다.
- 아마존에서 서버를 관리한다.
- 15분이라는 실행제한시간이 있지만, 한 회사의 채용공고를 다 긁어오는데 15분씩이나 걸리지는 않는다.
- [AWS CloudWatch와 연동하여 주기적인 실행이 가능](https://docs.aws.amazon.com/ko_kr/AmazonCloudWatch/latest/events/RunLambdaSchedule.html)하다.
- 더 많이 쓰면 그냥 돈을 더 많이 내면 된다.

### AWS Lambda, Azure Functions, Google Cloud Functions, nCloud Functions, ...

클라우드의 FaaS를 쓰기로 결정했다 해도, FaaS를 제공하는 서비스는 굉장히 많다. 세계에서 제일 유명한 클라우드 서비스만 하더라도 AWS, Azure, Google Cloud 3개가 있고, 이 세 군데는 모두 FaaS를 제공한다. 국내 회사인 [네이버 클라우드가 제공하는 Functions](https://www.ncloud.com/product/compute/cloudFunctions)라는 서비스도 있다. 이 중 AWS Lambda를 선택한 논리는 단순했다.

> 제일 유명한 게 AWS니까 AWS Lambda부터 알아보자. 불편한 부분이 있으면 다른 걸 찾아보지 뭐.

그리고 불편한 게 없었다고 한다.

### 저장소는 무엇을 쓸 것인가

AWS Lambda를 쓰기로 했다는 것은, serverless 환경을 구성하기로 결정했다는 뜻이다. 따라서 EC2와 같은 서비스를 쓸 때와는 달리, 별도의 데이터베이스 서버가 구동되어 있어야 함을 의미한다. 고려할 수 있는 옵션은 다음과 같았다.

- AWS DynamoDB
- Firebase
- MongoDB Atlas
- mLab
- AWS DocumentDB
- 어차피 웹서버(EC2) 돌릴 거, 거기다가 같이 달아버린다.

원래 서비스를 오픈할 생각 없이 토이프로젝트로 만들기 시작했기 때문에 DBMS를 그냥 쓰기 편한걸 골랐었다. 따라서 MongoDB 기반으로 이미 코딩이 끝난 상태라 DynamoDB와 Firebase는 제외하기로 했다.

Atlas는 몽고디비에서 공식적으로 지원하는 클라우드 데이터베이스 서비스다. 프리티어의 경우 512MB 용량까지 사용할 수 있고, 바로 윗 단계인 2GB 크기의 M2를 쓰게 되면 월 만원 정도가 부과된다고 한다. 현재 6개 회사를 크롤링했을 때 데이터 및 인덱스 사이즈가 1MB가 채 되지 않는 점, 그리고 채용공고 데이터를 쌓아두는 것이 아니라 내려간 공고는 데이터베이스에서도 삭제한다는 점을 감안하면 절대 512MB를 넘길 일은 없을 것이라 판단한다.

mLab은 MongoDB Atlas와 매우 유사한 서비스다. 그리고 [2018년 10월 부로 MongoDB에게 먹혔다](https://blog.mlab.com/2018/10/mlab-is-becoming-a-part-of-mongodb-inc/). 따라서 자동으로 열외.

DocumentDB는 AWS에서 2019년 1월부로 개시한 문서 데이터베이스 서비스로 MongoDB 3.6 API와 호환된다. MongoDB 서비스가 아니라 호환이기 때문에 모든 기능을 100% 쓸 수는 없을 테지만, 나 같은 애송이 수준에서 쓸 때는 두 API에 어떤 차이가 있는지 느끼기 어려울 것이라 생각한다. 문제는 [요금](https://aws.amazon.com/ko/documentdb/pricing/)인데, 데이터송수신량에 대한 요금은 거의 신경 쓸 필요 없지만, 구동시간에 따라 요금이 발생하고 이 요금이 생각보다 크다. 가장 싼 서비스가 버지니아의 db.r4.large인데 0.277 USD/hr으로 한 달이 약 720시간임을 감안하면 월 20만원 이상의 금액이 나오게 된다.

마지막으로 그냥 웹서버에서 포트 하나 더 열어서 DB서버를 겸하는 방법이 있다. 사실 이게 제일 나을 수도 있다. 웹서버에 DB가 바로 붙어있으면 응답속도가 빨라지기 때문이다. scale out이 어렵다는 단점이 있지만 scale out 계획이 없고, 가치 있는 데이터를 모은 것이 아니기 때문에 보안이나 안정성에 대한 요구도 없다.

위의 이유로 뺄 거 빼고 나면 남는 건 MongoDB Atlas와 EC2에 의존하는 DB서버 두 가지다. EC2는 1년 뒤에 프리티어가 만료될텐데 그 때 EC2를 계속 켜둘지는 미지수다. 이 때 웹서버는 죽어있더라도 별도의 DB서버와 람다 크롤링서버가 계속해서 돌고 있다면, 개인이 소스코드를 받아서 로컬에서 구동시킨 웹서버를 통해 계속 서비스를 이용할 수 있을 것이다. (개발자밖에 못 쓰겠지만...) 따라서 MongoDB Atlas를 쓰기로 결정했다.



## 전체 구성도

| <img src="https://raw.githubusercontent.com/3jins/Images/master/jobseek-cloud-architecture.png" width="70%"/> |
| :----------------------------------------------------------: |
|             글은 길었는데 어째 구조는 단순하다.              |



## 삽질기

(4편, 5편은 사실상 윈도우 삽질이다.)

1. serverless 환경을 선택한 이유#채용공고 크롤링 서비스 제작기 (현재 글)
2. [MongoDB Atlas 삽질기](https://enhanced.kr/postviewer/140)
3. [Serverless 삽질기](https://enhanced.kr/postviewer/141)
4. [Puppeteer on AWS Lambda](https://enhanced.kr/postviewer/142)























